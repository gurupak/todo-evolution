openapi: 3.1.0
info:
  title: Todo AI Chatbot API
  version: 1.0.0
  description: |-
    REST API for conversational AI chat interface to manage todos.

    **Features**:
    - Stateless chat endpoint with conversation history
    - Natural language task management via AI agent
    - MCP tools for database operations
    - Input/output guardrails for topic validation
    - JWT authentication with user isolation

    **Flow**:
    1. Client sends message with optional conversation_id
    2. Server loads conversation history from database
    3. Server runs input guardrail (blocks off-topic)
    4. Server runs AI agent with MCP tools
    5. Server runs output guardrail (validates response)
    6. Server saves messages to database
    7. Server returns AI response with tool calls

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.todo-app.com
    description: Production server

security:
  - BearerAuth: []

paths:
  /api/{user_id}/chat:
    post:
      summary: Send chat message to AI assistant
      description: |-
        Send a message to the AI assistant and receive a response. The assistant
        manages todos through natural language using MCP tools. Conversation
        history is loaded from database and truncated if exceeding token limit.

        **Guardrails**:
        - Input: Blocks off-topic messages (weather, coding help, etc.)
        - Output: Validates response stays on-topic

        **Stateless Design**:
        - No server-side session state
        - Full conversation history loaded per request
        - Conversation ID identifies which history to load
      operationId: sendChatMessage
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: Authenticated user ID (must match JWT token)
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              newConversation:
                summary: Start new conversation
                value:
                  message: "Add task to buy groceries"
              resumeConversation:
                summary: Resume existing conversation
                value:
                  conversation_id: "660e8400-e29b-41d4-a716-446655440001"
                  message: "What are my pending tasks?"
      responses:
        '200':
          description: Successful response from AI assistant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                taskCreated:
                  summary: Task created via chat
                  value:
                    conversation_id: "660e8400-e29b-41d4-a716-446655440001"
                    response: "I've added the task 'Buy groceries' to your list."
                    tool_calls:
                      - tool: "add_task"
                        arguments:
                          user_id: "550e8400-e29b-41d4-a716-446655440000"
                          title: "Buy groceries"
                          description: ""
                        result:
                          success: true
                          task:
                            id: "770e8400-e29b-41d4-a716-446655440002"
                            title: "Buy groceries"
                            is_completed: false
                taskList:
                  summary: Task list retrieved
                  value:
                    conversation_id: "660e8400-e29b-41d4-a716-446655440001"
                    response: "You have 3 pending tasks: 1) Buy groceries, 2) Call mom, 3) Finish report."
                    tool_calls:
                      - tool: "list_tasks"
                        arguments:
                          user_id: "550e8400-e29b-41d4-a716-446655440000"
                          status: "pending"
                        result:
                          success: true
                          count: 3
                          tasks:
                            - id: "770e8400-e29b-41d4-a716-446655440002"
                              title: "Buy groceries"
                              is_completed: false
                            - id: "770e8400-e29b-41d4-a716-446655440003"
                              title: "Call mom"
                              is_completed: false
                            - id: "770e8400-e29b-41d4-a716-446655440004"
                              title: "Finish report"
                              is_completed: false
        '400':
          description: Bad request (validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyMessage:
                  summary: Empty message
                  value:
                    error: "Message cannot be empty"
                    code: "VALIDATION_ERROR"
                messageTooLong:
                  summary: Message exceeds length limit
                  value:
                    error: "Message too long (max 2000 characters)"
                    code: "VALIDATION_ERROR"
        '401':
          description: Unauthorized (missing or invalid JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingToken:
                  summary: No JWT token provided
                  value:
                    error: "Authentication required"
                    code: "UNAUTHORIZED"
        '403':
          description: Forbidden (user_id doesn't match JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                userMismatch:
                  summary: Path user_id doesn't match JWT
                  value:
                    error: "Access denied: user_id mismatch"
                    code: "FORBIDDEN"
                offTopicBlocked:
                  summary: Guardrail blocked off-topic message
                  value:
                    error: "I'm your todo assistant and can only help with task management. I can help you: add tasks, view tasks, mark complete, delete tasks, update details. What would you like to do?"
                    code: "GUARDRAIL_BLOCKED"
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                conversationNotFound:
                  summary: Invalid conversation_id
                  value:
                    error: "Conversation not found or access denied"
                    code: "NOT_FOUND"
        '429':
          description: Rate limit exceeded (OpenAI API)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimitExceeded:
                  summary: Too many requests to AI API
                  value:
                    error: "High demand. Please wait 30s and try again."
                    code: "RATE_LIMIT"
                    retry_after: 30
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                agentError:
                  summary: AI agent failure
                  value:
                    error: "Unable to process request. Please try again."
                    code: "INTERNAL_ERROR"
                databaseError:
                  summary: Database connection failure
                  value:
                    error: "Unable to connect to database"
                    code: "DATABASE_ERROR"

  /api/{user_id}/conversations:
    get:
      summary: List user's conversations
      description: |-
        Retrieve a list of the authenticated user's conversations, sorted by
        most recent activity. Includes the last message preview for each
        conversation.
      operationId: listConversations
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: Authenticated user ID (must match JWT token)
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          required: false
          description: Number of conversations to skip (pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/{user_id}/conversations/{conversation_id}:
    get:
      summary: Get conversation details with message history
      description: |-
        Retrieve full message history for a specific conversation. Messages
        are returned in chronological order (oldest first).
      operationId: getConversation
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: Authenticated user ID
          schema:
            type: string
            format: uuid
        - name: conversation_id
          in: path
          required: true
          description: Conversation ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of messages to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          required: false
          description: Number of messages to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Conversation with messages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetailResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete conversation
      description: |-
        Delete a conversation and all its messages. This action is irreversible.
      operationId: deleteConversation
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: Authenticated user ID
          schema:
            type: string
            format: uuid
        - name: conversation_id
          in: path
          required: true
          description: Conversation ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Conversation deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |-
        JWT token from Better Auth authentication. Token must contain user_id
        claim that matches the {user_id} path parameter.

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        conversation_id:
          type: string
          format: uuid
          description: |-
            Existing conversation ID to resume. Omit to start new conversation.
          example: "660e8400-e29b-41d4-a716-446655440001"
        message:
          type: string
          minLength: 1
          maxLength: 2000
          description: User message content
          example: "Add task to buy groceries"

    ChatResponse:
      type: object
      required:
        - conversation_id
        - response
      properties:
        conversation_id:
          type: string
          format: uuid
          description: Conversation ID (new or existing)
          example: "660e8400-e29b-41d4-a716-446655440001"
        response:
          type: string
          description: AI assistant response
          example: "I've added the task 'Buy groceries' to your list."
        tool_calls:
          type: array
          description: MCP tools invoked by AI (if any)
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      required:
        - tool
        - arguments
        - result
      properties:
        tool:
          type: string
          description: MCP tool name
          enum:
            - add_task
            - list_tasks
            - complete_task
            - delete_task
            - update_task
          example: "add_task"
        arguments:
          type: object
          description: Tool input parameters
          additionalProperties: true
          example:
            user_id: "550e8400-e29b-41d4-a716-446655440000"
            title: "Buy groceries"
            description: ""
        result:
          type: object
          description: Tool execution result
          additionalProperties: true
          example:
            success: true
            task:
              id: "770e8400-e29b-41d4-a716-446655440002"
              title: "Buy groceries"
              is_completed: false

    ConversationListResponse:
      type: object
      required:
        - conversations
        - total
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/ConversationSummary'
        total:
          type: integer
          description: Total number of conversations (for pagination)
          example: 15
        limit:
          type: integer
          description: Number of conversations returned
          example: 20
        offset:
          type: integer
          description: Offset used for pagination
          example: 0

    ConversationSummary:
      type: object
      required:
        - id
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        created_at:
          type: string
          format: date-time
          example: "2025-12-25T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-12-25T14:45:00Z"
        last_message:
          type: string
          nullable: true
          description: Preview of most recent message
          example: "I've added the task 'Buy groceries' to your list."

    ConversationDetailResponse:
      type: object
      required:
        - id
        - created_at
        - updated_at
        - messages
      properties:
        id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        created_at:
          type: string
          format: date-time
          example: "2025-12-25T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-12-25T14:45:00Z"
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        total_messages:
          type: integer
          description: Total message count (for pagination)
          example: 12

    Message:
      type: object
      required:
        - id
        - role
        - content
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "880e8400-e29b-41d4-a716-446655440005"
        role:
          type: string
          enum:
            - user
            - assistant
          example: "user"
        content:
          type: string
          example: "Add task to buy groceries"
        tool_calls:
          type: array
          nullable: true
          description: Present only for assistant messages
          items:
            $ref: '#/components/schemas/ToolCall'
        created_at:
          type: string
          format: date-time
          example: "2025-12-25T10:31:00Z"

    ErrorResponse:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: "Message cannot be empty"
        code:
          type: string
          description: Machine-readable error code
          enum:
            - VALIDATION_ERROR
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - RATE_LIMIT
            - GUARDRAIL_BLOCKED
            - DATABASE_ERROR
            - INTERNAL_ERROR
          example: "VALIDATION_ERROR"
        retry_after:
          type: integer
          nullable: true
          description: Seconds to wait before retrying (rate limit only)
          example: 30

tags:
  - name: Chat
    description: Conversational AI chat endpoints for todo management
